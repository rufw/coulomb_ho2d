BASEDIR=.
OUTDIR=$(BASEDIR)/dist/
DOCDIR=$(OUTDIR)/doc/
INTDIR=$(OUTDIR)/tmp
ARFLAGS=-cru
CFLAGS=-pedantic -Wall -std=c99 -O3 -ffast-math -DNDEBUG
REMOTE=git@github-xrf:xrf/coulomb_ho2d.git

lib: $(OUTDIR)/libcoulombho2d.a

all: lib test

$(OUTDIR)/libcoulombho2d.a: $(INTDIR)/coulomb_ho2d.o
	mkdir -p $(OUTDIR)
	$(AR) $(ARFLAGS) $(OUTDIR)/libcoulombho2d.a \
	        $(INTDIR)/coulomb_ho2d.o

$(INTDIR)/coulomb_ho2d.o: coulomb_ho2d.c
	mkdir -p $(INTDIR)
	$(CC) $(CFLAGS) -o $(INTDIR)/coulomb_ho2d.o -c coulomb_ho2d.c

test:
	cd test && make

test-compilers:
	gcc -Wall -pedantic -x c -c coulomb_ho2d.c
	g++ -Wall -pedantic -x c -c coulomb_ho2d.c
	g++ -Wall -pedantic -std=c89 -x c -c coulomb_ho2d.c
	g++ -Wall -pedantic -std=c99 -x c -c coulomb_ho2d.c
	g++ -Wall -pedantic -x c++ -c coulomb_ho2d.c
	g++ -Wall -pedantic -std=c++03 -x c++ -c coulomb_ho2d.c
	g++ -Wall -pedantic -std=c++11 -x c++ -c coulomb_ho2d.c
	clang -Wall -pedantic -x c -c coulomb_ho2d.c
	clang++ -Wall -pedantic -x c -c coulomb_ho2d.c
	clang++ -Wall -pedantic -std=c89 -x c -c coulomb_ho2d.c
	clang++ -Wall -pedantic -std=c99 -x c -c coulomb_ho2d.c
	clang++ -Wall -pedantic -x c++ -c coulomb_ho2d.c
	clang++ -Wall -pedantic -std=c++03 -x c++ -c coulomb_ho2d.c
	clang++ -Wall -pedantic -std=c++11 -x c++ -c coulomb_ho2d.c

doc: $(DOCDIR)/.git/config
	doxygen
	cd $(DOCDIR) \
	  && git add -A \
	  && git commit --amend -q -m Autogenerated --author="Bot <>" \
	  && git push -f origin master:gh-pages

$(DOCDIR)/.git/config:
	mkdir -p $(DOCDIR)
	cd $(DOCDIR) \
	  && git init \
	  && git commit -m Initial --allow-empty \
	  && git remote add origin $(REMOTE)

clean:
	rm -fr $(OUTDIR) $(INTDIR) $(DOCDIR)

.PHONY: clean test test-compilers
